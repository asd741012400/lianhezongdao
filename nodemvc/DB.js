var Mongodb=require("mongodb"),MongoClient=Mongodb.MongoClient;module.exports={CONN_STR:Config.Mongo_CONN_STR,connect:function(i,e,n){n=n||this.CONN_STR,MongoClient.connect(n,function(n,t){n?(console.log("MongoDB connect Error:"+n),e&&e({result:!1,errorMsg:"连接数据库失败"})):i(t)})},regQuery:function(n,t){for(var i in t=t||"",n=n||{})n[i]={$regex:n[i],$options:t};return n},resultFn:function(n,t,i,e){i(n?{result:!1,errorMsg:n.message}:{result:!0,data:e?t.insertedIds:t})},_eval:function(n,e){var o=this;this.connect(function(i){i.eval(n,function(n,t){i.close(),o.resultFn(n,t,e)})},e)},find:function(e,o,s,r){var c=this;o=(r=r||{}).reg?this.regQuery(o,r.reg):o,r.projection=r.projection||{},r.projection._id=0,this.connect(function(i){if(r.findOne)i.collection(e).findOne(o,r.projection,function(n,t){i.close(),c.resultFn(n,t,s)});else{var n=i.collection(e).find(o,r.projection);if(r.sort&&n.sort(r.sort),r.limit&&n.limit(r.limit),r.skip&&n.skip(r.skip),r.findFn)for(var t in r.findFn)null!=r.findFn[t]&&(n=n[t](r.findFn[t]));r.count?n.count(function(n,t){i.close(),c.resultFn(n,t,s)}):n.toArray(function(n,t){i.close(),c.resultFn(n,t,s)})}},s)},insert:function(n,t,e,i){var o=this;i=i||{},this.connect(function(i){i.collection(n).insert(t,function(n,t){i.close(),o.resultFn(n,t,e,!0)})},e)},update:function(n,t,e,o,s){var r=this;t=(s=s||{}).reg?this.regQuery(t,s.reg):t,s.multi=null==s.multi||s.multi,this.connect(function(i){i.collection(n).update(t,{$set:e},{multi:s.multi},function(n,t){i.close(),r.resultFn(n,t,o)})},o)},remove:function(n,t,e,o){var s=this;t=(o=o||{}).reg?this.regQuery(t,o.reg):t,o.justOne=null!=o.justOne&&o.justOne,this.connect(function(i){i.collection(n).remove(t,{justOne:o.justOne},function(n,t){i.close(),s.resultFn(n,t,e)})},e)},jsSave:function(n,t,e){var o=this;this.connect(function(i){i.eval('db.system.js.save({_id:"'+n+'",value:'+t.toString()+"})",function(n,t){i.close(),o.resultFn(n,t,e)})},e)},jsLoad:function(n,e){var o=this;this.connect(function(i){i.eval("db.loadServerScripts();"+n,function(n,t){i.close(),o.resultFn(n,t,e)})},e)},jsFind:function(n,t){n=n||{},this.jsLoad('find("'+n.name+'",'+JSON.stringify(n.keys)+","+JSON.stringify(n.args)+")",t)},jsList:function(n,t){(n=n||{}).args=n.args||{},n.args.pageSize=n.args.pageSize||10,n.args.pageNum=n.args.pageNum||1,this.jsLoad('list("'+n.name+'",'+JSON.stringify(n.keys)+","+JSON.stringify(n.args)+")",t)}};